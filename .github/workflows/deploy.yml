name: "ğŸš€ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ (ãƒ‡ãƒãƒƒã‚°)"

on:
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã®ã¿

jobs:
  debug-build-artifacts:
    name: ğŸ” ãƒ“ãƒ«ãƒ‰æˆæœç‰©ãƒ‡ãƒãƒƒã‚°
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: ğŸ“¦ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: ğŸ—ï¸ å…¨ä½“ãƒ“ãƒ«ãƒ‰
        run: npx turbo run build

      # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ã®ç¢ºèª
      - name: ğŸ“‚ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ã‚’ç¢ºèª
        run: |
          echo "==== ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€  ===="
          ls -la

          echo "==== apps ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ§‹é€  ===="
          ls -la apps/

          echo "==== beatfolio ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ§‹é€  ===="
          ls -la apps/beatfolio/

          echo "==== api-server ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ§‹é€  ===="
          ls -la apps/api-server/

      # ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ç¢ºèª
      - name: ğŸ“‚ ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®å ´æ‰€ã‚’æ¤œç´¢
        run: |
          echo "==== beatfolio ã® .next ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ¢ã™ ===="
          find apps/beatfolio -name ".next" -type d | xargs -I{} ls -la {}

          echo "==== api-server ã® .next ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ¢ã™ ===="
          find apps/api-server -name ".next" -type d | xargs -I{} ls -la {}

          echo "==== Next.js ã®å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ¤œç´¢ ===="
          find apps -name "out" -type d | xargs -I{} ls -la {}

          echo "==== package.json å†…ã® build ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç¢ºèª ===="
          cat apps/beatfolio/package.json | grep "\"build\""
          cat apps/api-server/package.json | grep "\"build\""

      # ãƒ“ãƒ«ãƒ‰ãƒ­ã‚°ã®è©³ç´°ç¢ºèª
      - name: ğŸ” è©³ç´°ãªãƒ“ãƒ«ãƒ‰ãƒ­ã‚°
        run: |
          echo "==== Beatfolio ã®è©³ç´°ãƒ“ãƒ«ãƒ‰ ===="
          cd apps/beatfolio
          npm run build -- --verbose

          echo "==== API Server ã®è©³ç´°ãƒ“ãƒ«ãƒ‰ ===="
          cd ../api-server
          npm run build -- --verbose

      # turbo.json ã®ç¢ºèª
      - name: ğŸ“„ turbo.json ã®å†…å®¹ç¢ºèª
        run: |
          echo "==== turbo.json ã®å†…å®¹ ===="
          cat turbo.json

      # ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: ğŸ“¤ beatfolioãƒ“ãƒ«ãƒ‰ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç¢ºèª
        run: |
          if [ -d "apps/beatfolio/.next" ]; then
            echo "âœ… apps/beatfolio/.next ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã™"
            echo "==== ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹ ===="
            ls -la apps/beatfolio/.next
          else
            echo "âŒ apps/beatfolio/.next ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "ãƒ“ãƒ«ãƒ‰å‡ºåŠ›ã®å ´æ‰€ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          fi

      - name: ğŸ“¤ APIã‚µãƒ¼ãƒãƒ¼ãƒ“ãƒ«ãƒ‰ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç¢ºèª
        run: |
          if [ -d "apps/api-server/.next" ]; then
            echo "âœ… apps/api-server/.next ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã™"
            echo "==== ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹ ===="
            ls -la apps/api-server/.next
          else
            echo "âŒ apps/api-server/.next ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "ãƒ“ãƒ«ãƒ‰å‡ºåŠ›ã®å ´æ‰€ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          fi
